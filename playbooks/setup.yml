---

- name: Determine if host was built from a cloudhost image
  hosts: cloudhost,saashost
  become: true
  tasks:
    - name: Check if /etc/nexcess directory exists
      stat:
        path: /etc/nexcess
      register: nex_dir_stat

    - name: Set nex_skip_roles based on status of directory
      set_fact:
        nex_skip_roles: '{{ nex_dir_stat.stat.exists }}'

- name: RHEL7 Swap repo to nexcess
  hosts: cloudhost,saashost
  become: true
  tasks:
    - shell: 'sed -i -e "s/mirrorlist/#mirrorlist/" -e "s/#baseurl/baseurl/" -e "s/mirror.centos.org\/centos\//mirror.us-midwest-1.nexcess.net\/CentOS\//" /etc/yum.repos.d/CentOS-Base.repo'
      when:
        - ansible_os_family == 'RedHat'
        - ansible_distribution_major_version == '7'

- include: base.yml
  when:
    - not nex_skip_roles | bool

- name: Setup an InterWorx Server
  hosts: cloudhost,saashost
  become: true
  any_errors_fatal: true
  pre_tasks:
    - include: tasks/cloudhost.yml mode="pre"
      when:
        - not nex_skip_roles | bool
  roles:
    - role: nexcess.mariadb
      when:
        - not nex_skip_roles | bool
    - role: nexcess.interworx
      when:
        - not nex_skip_roles | bool
    - role: nexcess.puppet
      when:
        - nex_env_target is undefined or nex_env_target != 'vagrant'
        - not nex_skip_roles | bool
  post_tasks:
    - include: tasks/cloudhost.yml mode="post"
      when:
        - not nex_skip_roles | bool

- name: Run post-init script when built from an image
  become: true
  hosts: cloudhost,saashost
  tasks:
    - name: Deploy init script to new cloudhost
      template:
        src: scripts/cloudhost-init.sh.j2
        dest: /tmp/cloudhost-init.sh
        mode: 700
      when:
        - nex_skip_roles | bool

    - name: Run the init script for new cloudhost
      shell:
        cmd: /tmp/cloudhost-init.sh
      when:
        - nex_skip_roles | bool

    - name: Remove init script after completion
      file:
        path: /tmp/cloudhost-init.sh
        state: absent
      when:
        - nex_skip_roles | bool
